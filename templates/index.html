<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="keywords" content="AI image restoration, photo enhancement, old photo repair">
    <meta name="description" content="Restore old photos with AI-powered denoising, upscaling, and generative fill.">
    <title>AI Image Restoration</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gray-50">
    <!-- Header -->
    <header class="bg-blue-600 text-white shadow-md">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <h1 class="text-2xl font-bold">AI Image Restoration</h1>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Controls -->
            <aside class="space-y-6">
                <!-- Upload -->
                <section class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-lg font-semibold mb-4 text-gray-800">Upload Image</h2>
                    <input type="file" id="imageUpload" accept="image/*" 
                        class="block w-full text-sm text-gray-600 file:mr-4 file:py-2 file:px-4 
                        file:rounded file:border file:border-blue-600 file:bg-blue-600 
                        file:text-white hover:file:bg-blue-700 file:cursor-pointer">
                </section>

                <!-- Options -->
                <section class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-lg font-semibold mb-4 text-gray-800">Options</h2>
                    <div class="space-y-3">
                        <label class="flex items-center gap-3 cursor-pointer">
                            <input type="checkbox" id="denoise" checked 
                                class="w-5 h-5 text-blue-600 border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                            <span class="text-gray-700">Denoise</span>
                        </label>
                        <label class="flex items-center gap-3 cursor-pointer">
                            <input type="checkbox" id="upscale" 
                                class="w-5 h-5 text-blue-600 border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                            <span class="text-gray-700">Upscale (4x)</span>
                        </label>
                        <label class="flex items-center gap-3 cursor-pointer">
                            <input type="checkbox" id="enhance" checked 
                                class="w-5 h-5 text-blue-600 border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                            <span class="text-gray-700">Enhance</span>
                        </label>
                        <label class="flex items-center gap-3 cursor-pointer">
                            <input type="checkbox" id="faceEnhance" 
                                class="w-5 h-5 text-blue-600 border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                            <span class="text-gray-700">Face Enhancement</span>
                        </label>
                    </div>
                </section>

                <!-- Generative Fill -->
                <section class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-lg font-semibold mb-4 text-gray-800">Generative Fill</h2>
                    <div class="space-y-4">
                        <input type="text" id="prompt" placeholder="Enter prompt (e.g., smooth skin)" 
                            class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-blue-600">
                        <div class="flex gap-2">
                            <button id="clearMask" 
                                class="flex-1 bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition">
                                Clear Mask
                            </button>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-700 mb-2">
                                Brush Size: <span id="brushSizeValue">10</span>px
                            </label>
                            <input type="range" id="brushSize" min="5" max="50" value="10" 
                                class="w-full h-2 bg-gray-200 rounded cursor-pointer">
                        </div>
                    </div>
                </section>

                <!-- Process Button -->
                <button id="process" 
                    class="w-full bg-blue-600 text-white px-6 py-3 rounded font-semibold hover:bg-blue-700 transition disabled:bg-gray-400 disabled:cursor-not-allowed">
                    Process Image
                </button>
            </aside>

            <!-- Canvas & Results -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Canvas -->
                <section class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-lg font-semibold mb-4 text-gray-800">Draw Mask (Green = Fill Area)</h2>
                    <canvas id="canvas" class="w-full border-2 border-gray-300 rounded cursor-crosshair"></canvas>
                </section>

                <!-- Results -->
                <section class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-lg font-semibold mb-4 text-gray-800">Results</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <h3 class="text-sm font-medium mb-2 text-gray-600">Original</h3>
                            <img id="originalImage" class="w-full h-auto rounded border border-gray-300" alt="Original">
                        </div>
                        <div>
                            <h3 class="text-sm font-medium mb-2 text-gray-600">Restored</h3>
                            <img id="restoredImage" class="w-full h-auto rounded border border-gray-300" alt="Restored">
                        </div>
                    </div>
                    <button id="download" 
                        class="mt-4 w-full bg-green-600 text-white px-6 py-3 rounded font-semibold hover:bg-green-700 transition hidden">
                        Download Restored Image
                    </button>
                </section>
            </div>
        </div>
    </main>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let drawing = false;
        let brushSize = 10;
        let originalImage = null;
        let originalImageWidth = 0;
        let originalImageHeight = 0;
        let canvasScaleX = 1;
        let canvasScaleY = 1;

        ctx.lineWidth = brushSize;
        ctx.strokeStyle = 'green';
        ctx.lineCap = 'round';

        function resizeCanvas(img) {
            const maxWidth = window.innerWidth < 640 ? window.innerWidth - 40 : 800;
            const aspectRatio = img.width / img.height;
            canvas.width = Math.min(img.width, maxWidth);
            canvas.height = canvas.width / aspectRatio;
            originalImageWidth = img.width;
            originalImageHeight = img.height;
            canvasScaleX = originalImageWidth / canvas.width;
            canvasScaleY = originalImageHeight / canvas.height;
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = 'green';
            ctx.lineCap = 'round';
            ctx.lineWidth = brushSize;
        }

        document.getElementById('imageUpload').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                originalImage = new Image();
                originalImage.src = URL.createObjectURL(file);
                originalImage.onload = () => {
                    resizeCanvas(originalImage);
                    document.getElementById('originalImage').src = originalImage.src;
                    document.getElementById('restoredImage').src = '';
                    document.getElementById('download').classList.add('hidden');
                };
            }
        });

        document.getElementById('brushSize').addEventListener('input', (e) => {
            brushSize = e.target.value;
            ctx.lineWidth = brushSize;
            document.getElementById('brushSizeValue').textContent = brushSize;
        });

        document.getElementById('clearMask').addEventListener('click', () => {
            if (originalImage) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(originalImage, 0, 0, canvas.width, canvas.height);
            }
        });

        canvas.addEventListener('mousedown', (e) => {
            drawing = true;
            ctx.beginPath();
            ctx.moveTo(e.offsetX, e.offsetY);
        });

        canvas.addEventListener('mousemove', (e) => {
            if (drawing) {
                ctx.lineTo(e.offsetX, e.offsetY);
                ctx.stroke();
            }
        });

        canvas.addEventListener('mouseup', () => drawing = false);
        canvas.addEventListener('mouseout', () => drawing = false);

        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            drawing = true;
            const rect = canvas.getBoundingClientRect();
            const touch = e.touches[0];
            ctx.beginPath();
            ctx.moveTo(touch.clientX - rect.left, touch.clientY - rect.top);
        });

        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            if (drawing) {
                const rect = canvas.getBoundingClientRect();
                const touch = e.touches[0];
                ctx.lineTo(touch.clientX - rect.left, touch.clientY - rect.top);
                ctx.stroke();
            }
        });

        canvas.addEventListener('touchend', () => drawing = false);

        document.getElementById('process').addEventListener('click', async () => {
            if (!originalImage) {
                alert('Please upload an image first.');
                return;
            }

            const formData = new FormData();
            formData.append('image', document.getElementById('imageUpload').files[0]);
            formData.append('denoise', document.getElementById('denoise').checked);
            formData.append('upscale', document.getElementById('upscale').checked);
            formData.append('enhance', document.getElementById('enhance').checked);
            formData.append('faceEnhance', document.getElementById('faceEnhance').checked);
            formData.append('prompt', document.getElementById('prompt').value);

            const maskCanvas = document.createElement('canvas');
            maskCanvas.width = originalImageWidth;
            maskCanvas.height = originalImageHeight;
            const maskCtx = maskCanvas.getContext('2d');
            maskCtx.scale(canvasScaleX, canvasScaleY);
            maskCtx.drawImage(canvas, 0, 0);
            maskCtx.setTransform(1, 0, 0, 1, 0, 0);

            const imageData = maskCtx.getImageData(0, 0, maskCanvas.width, maskCanvas.height);
            for (let i = 0; i < imageData.data.length; i += 4) {
                const r = imageData.data[i];
                const g = imageData.data[i + 1];
                const b = imageData.data[i + 2];
                if (g > 50 && r < 50 && b < 50) {
                    imageData.data[i] = 255;
                    imageData.data[i + 1] = 255;
                    imageData.data[i + 2] = 255;
                    imageData.data[i + 3] = 255;
                } else {
                    imageData.data[i] = 0;
                    imageData.data[i + 1] = 0;
                    imageData.data[i + 2] = 0;
                    imageData.data[i + 3] = 255;
                }
            }
            maskCtx.putImageData(imageData, 0, 0);

            maskCanvas.toBlob((blob) => {
                formData.append('mask', blob, 'mask.png');

                const processBtn = document.getElementById('process');
                processBtn.disabled = true;
                processBtn.textContent = 'Processing...';

                fetch('/process', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('Error: ' + data.error);
                    } else {
                        const restoredImg = document.getElementById('restoredImage');
                        restoredImg.src = 'data:image/png;base64,' + data.restored_image;
                        const downloadBtn = document.getElementById('download');
                        downloadBtn.classList.remove('hidden');
                        downloadBtn.onclick = () => {
                            const link = document.createElement('a');
                            link.href = restoredImg.src;
                            link.download = 'restored_image.png';
                            link.click();
                        };
                    }
                })
                .catch(error => alert('Error: ' + error))
                .finally(() => {
                    processBtn.disabled = false;
                    processBtn.textContent = 'Process Image';
                });
            });
        });
    </script>
</body>
</html>
